<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì§€ë„ ê²€ìƒ‰(í‚¤ì›Œë“œ/ë°˜ê²½/ì¥ì†Œ) - Kakao</title>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;}
    #map{width:100vw;height:calc(100vh - 118px);}
    .bar{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #eee}
    .row{display:flex;gap:8px;padding:10px;align-items:center;flex-wrap:wrap}
    .row input,.row select{padding:10px;border:1px solid #ddd;border-radius:10px}
    .row input{flex:1;min-width:180px}
    .row button{padding:10px 12px;border:0;border-radius:10px;background:#111;color:#fff;font-weight:700}
    .status{padding:8px 10px;color:#666;font-size:12px;border-top:1px solid #eee}
  </style>

  <!-- ë°˜ë“œì‹œ JavaScript í‚¤ë¡œ êµì²´ + ë„ë©”ì¸ ë“±ë¡(https://hanuseok.github.io) -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_JS_KEY&libraries=services,clusterer&autoload=false"></script>
</head>
<body>
  <div class="bar">
    <div class="row">
      <input id="place" placeholder="ì–´ë””ì—ì„œ? (ì˜ˆ: í™ëŒ€ì…êµ¬ì—­, ì„±ìˆ˜ë™, ì£¼ì†Œ)" />
      <input id="keyword" placeholder="ë¬´ì—‡ì„? (ì˜ˆ: ì¹´í˜, í¸ì˜ì , ì•½êµ­ Â· ë¹„ìš°ë©´ ê¸°ë³¸ê°’)" />
      <select id="radius">
        <option value="500">500m</option>
        <option value="1000" selected>1km</option>
        <option value="2000">2km</option>
        <option value="3000">3km</option>
      </select>
      <button id="btnSearch">ê²€ìƒ‰</button>
      <button id="btnMy">ë‚´ ìœ„ì¹˜</button>
    </div>
    <div class="status" id="status">ì´ˆê¸°í™” ì¤‘...</div>
  </div>

  <div id="map"></div>

  <script>
  // ================= ê³µìš© ìœ í‹¸ =================
  function postOutbound(payload){
    try{
      const data = JSON.stringify(payload);
      if (window.ReactNativeWebView) window.ReactNativeWebView.postMessage(data);
      else if (window.parent && window.parent !== window) window.parent.postMessage(data, '*');
    }catch(e){}
  }
  function emitStatus(text){
    const el = document.getElementById('status'); if (el) el.textContent = text;
    postOutbound({ type:'SEARCH_STATUS', text });
  }

  // Kakao SDK ì¤€ë¹„
  if (!window.kakao){ emitStatus('âŒ Kakao SDK ë¡œë“œ ì‹¤íŒ¨ â€” ë„ë©”ì¸/í‚¤ í™•ì¸'); throw new Error('Kakao SDK not loaded'); }

  kakao.maps.load(function(){
    // =============== ì§€ë„/ì„œë¹„ìŠ¤ ì¤€ë¹„ ===============
    const map = new kakao.maps.Map(document.getElementById('map'), {
      center: new kakao.maps.LatLng(37.4979, 127.0276),
      level: 5
    });
    const ps = new kakao.maps.services.Places();
    const clusterer = new kakao.maps.MarkerClusterer({ map, averageCenter:true, minLevel:6 });

    const $place = document.getElementById('place');
    const $keyword = document.getElementById('keyword');
    const $radius = document.getElementById('radius');

    let markers = [];
    let originMarker = null;

    function clearMarkers(){ markers.forEach(m => m.setMap(null)); markers = []; clusterer.clear(); }
    function setOrigin(lat, lng){
      if (originMarker) originMarker.setMap(null);
      originMarker = new kakao.maps.Marker({ position: new kakao.maps.LatLng(lat, lng), zIndex: 10 });
      originMarker.setMap(map);
      map.setCenter(originMarker.getPosition());
    }
    function addPlaceMarker(place){
      const m = new kakao.maps.Marker({ position: new kakao.maps.LatLng(place.y, place.x) });
      const html = '<div style="padding:8px;min-width:180px;"><b>'+(place.place_name||'')+
        '</b><br><small style="color:#666">'+(place.road_address_name||place.address_name||'')+'</small>'+
        (place.phone?('<br><small style="color:#06c">'+place.phone+'</small>'):'')+
        '</div>';
      const info = new kakao.maps.InfoWindow({ content: html });
      kakao.maps.event.addListener(m, 'click', function(){
        info.open(map, m);
        postOutbound({
          type:'PLACE_SELECTED',
          place:{
            id:place.id, name:place.place_name,
            lat:parseFloat(place.y), lng:parseFloat(place.x),
            address:place.address_name, roadAddress:place.road_address_name,
            phone:place.phone, place_url:place.place_url
          }
        });
      });
      markers.push(m);
      return m;
    }

    // =============== í•µì‹¬: ê²€ìƒ‰ë§Œ ìˆ˜í–‰ ===============
    function searchNearby(center, kw, radius){
      clearMarkers();
      emitStatus('ğŸ” ê²€ìƒ‰ ì¤‘...');
      const keyword = (kw && kw.trim()) ? kw.trim() : 'ë…¸ë˜ë°©'; // ë¹„ìš°ë©´ ê¸°ë³¸ê°’(ì›í•˜ë©´ ë¹ˆ ê²€ìƒ‰ìœ¼ë¡œ ë°”ê¿”ë„ ë¨)
      ps.keywordSearch(keyword, function(data, status){
        if (status === kakao.maps.services.Status.OK && data && data.length){
          const uniq = {};
          data.forEach(p => { const k = p.id || (p.x+','+p.y); if(!uniq[k]) uniq[k] = p; });
          const places = Object.values(uniq);
          const ms = places.map(addPlaceMarker);
          clusterer.addMarkers(ms);
          emitStatus('âœ… ' + places.length + 'ê°œ ì¥ì†Œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤');
          const c = map.getCenter();
          postOutbound({ type:'SEARCH_DONE', keyword, count:places.length, radius: radius||1000, center:{ lat:c.getLat(), lng:c.getLng() }});
        } else {
          emitStatus('âš ï¸ ê²°ê³¼ ì—†ìŒ / status=' + status);
          const c = map.getCenter();
          postOutbound({ type:'SEARCH_DONE', keyword, count:0, radius: radius||1000, center:{ lat:c.getLat(), lng:c.getLng() }});
        }
      }, { location: center, radius: radius||1000 });
    }

    function resolvePlaceAndCenter(query, cb){
      if (!query || !query.trim()) { cb && cb(null); return; }
      ps.keywordSearch(query.trim(), function(data, status){
        if (status === kakao.maps.services.Status.OK && data && data.length){
          const p = data[0];
          const lat = parseFloat(p.y), lng = parseFloat(p.x);
          setOrigin(lat, lng);
          map.setLevel(5);
          cb && cb(new kakao.maps.LatLng(lat, lng));
        } else { emitStatus('âš ï¸ ì¥ì†Œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤'); cb && cb(null); }
      }, { size: 10 });
    }

    // ë²„íŠ¼: ê²€ìƒ‰/ë‚´ ìœ„ì¹˜
    document.getElementById('btnSearch').addEventListener('click', function(){
      const rad = parseInt($radius.value || '1000', 10);
      const kw  = $keyword.value || '';
      const q   = $place.value || '';
      if (q.trim()){
        resolvePlaceAndCenter(q, function(center){ if (center) searchNearby(center, kw, rad); });
      } else {
        searchNearby(map.getCenter(), kw, rad);
      }
    });
    document.getElementById('btnMy').addEventListener('click', function(){
      if (!navigator.geolocation) return emitStatus('âš ï¸ ìœ„ì¹˜ ê¶Œí•œì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      navigator.geolocation.getCurrentPosition(function(pos){
        setOrigin(pos.coords.latitude, pos.coords.longitude);
        map.setLevel(5);
        const rad = parseInt($radius.value || '1000', 10);
        const kw  = $keyword.value || '';
        searchNearby(map.getCenter(), kw, rad);
      }, function(){ emitStatus('âš ï¸ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤'); });
    });

    // ì§€ë„ í´ë¦­ â†’ ê·¸ ì§€ì ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ì • (ë°”ë¡œ ê²€ìƒ‰ì€ ì•ˆ í•¨)
    kakao.maps.event.addListener(map, 'click', function(e){
      setOrigin(e.latLng.getLat(), e.latLng.getLng());
      emitStatus('ğŸ“ ì„ íƒí•œ ì§€ì ìœ¼ë¡œ ì¤‘ì‹¬ ì´ë™');
    });

    // Expo/ë¶€ëª¨ â†’ ì œì–´ ë©”ì‹œì§€
    function handleMsg(raw){
      try{
        const o = JSON.parse(raw);
        if (o.type === 'CENTER' && typeof o.lat==='number' && typeof o.lng==='number'){
          setOrigin(o.lat, o.lng); if (o.level) map.setLevel(o.level);
        } else if (o.type === 'FIND_PLACE' && o.query){
          resolvePlaceAndCenter(o.query, function(center){ if (center && o.autoSearch){
            searchNearby(center, document.getElementById('keyword').value, parseInt($radius.value||'1000',10));
          } });
        } else if (o.type === 'SET_KEYWORD'){
          document.getElementById('keyword').value = (o.keyword||'');
        } else if (o.type === 'SET_RADIUS'){
          document.getElementById('radius').value = String(o.radius||1000);
        } else if (o.type === 'SEARCH_NOW'){
          const rad = parseInt($radius.value || '1000', 10);
          const kw  = document.getElementById('keyword').value || '';
          searchNearby(map.getCenter(), kw, rad);
        }
      }catch(e){}
    }
    window.addEventListener('message', (e)=>handleMsg(e.data));
    document.addEventListener('message', (e)=>handleMsg(e.data));

    // ì´ˆê¸° ìƒíƒœ
    emitStatus('âœ… ì§€ë„ ë¡œë“œ ì™„ë£Œ â€” ì¥ì†Œ/í‚¤ì›Œë“œ ì…ë ¥ í›„ [ê²€ìƒ‰]');
    setOrigin(37.4979, 127.0276);
  });
  </script>
</body>
</html>
