<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ì§€ë„ ê²€ìƒ‰(í‚¤ì›Œë“œ/ë°˜ê²½/ì¥ì†Œ) - Kakao</title>
  <style>
    /* Reset & base */
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;}
    #map{position:fixed;inset:0;z-index:0;} /* ì „ì²´ í™”ë©´ ì§€ë„ */
    /* í•˜ë‹¨ ì‹œíŠ¸ */
    .sheet{
      position:fixed;left:0;right:0;bottom:0;z-index:10;
      background:#fff;border-top:1px solid #eee;
      border-top-left-radius:16px;border-top-right-radius:16px;
      box-shadow:0 -8px 24px rgba(0,0,0,.08);
      padding:8px 12px calc(8px + env(safe-area-inset-bottom)); /* iOS Safe Area */
      transition:transform .18s ease;
    }
    .sheet.grab{cursor:grab}
    .sheet .handle{width:40px;height:4px;background:#d8d8d8;border-radius:2px;margin:4px auto 10px;}
    .sheet .row{display:flex;gap:8px;align-items:center}
    .sheet .stack{display:flex;flex-direction:column;gap:8px}
    .sheet input,.sheet select{
      padding:14px;border:1px solid #ddd;border-radius:12px;font-size:16px;flex:1;min-width:0
    }
    .sheet button{
      padding:14px 16px;border:0;border-radius:12px;background:#111;color:#fff;font-weight:700;font-size:16px
    }
    .sheet .status{
      margin-top:8px;color:#666;font-size:13px;line-height:1.3;min-height:18px
    }
    .fab{
      position:fixed;right:16px;bottom:calc(84px + env(safe-area-inset-bottom));
      z-index:9;border:0;border-radius:999px;
      padding:14px 16px;font-weight:700;background:#111;color:#fff;
      box-shadow:0 6px 20px rgba(0,0,0,.15);
    }
    /* ì ‘ê¸°/í´ê¸° ìƒíƒœ */
    .sheet.min{ transform:translateY(calc(100% - 64px - env(safe-area-inset-bottom))); }
    .sheet.max{ transform:translateY(0); }
    /* ë„“ì€ í™”ë©´(íƒœë¸”ë¦¿/ë°ìŠ¤í¬íƒ‘)ì—ì„œëŠ” ë¯¸ë‹ˆ ë†’ì´ ì¤„ì„ */
    @media (min-width:768px){
      .sheet.min{ transform:translateY(calc(100% - 76px)); }
      .fab{ bottom:110px; }
    }
  </style>

  <!-- Kakao SDK: ì‹¤ì œ JS í‚¤ + ë„ë©”ì¸(https://hanuseok.github.io) ë“±ë¡ í•„ìˆ˜ -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=d1edc654e39b717ae9109665b63453f6&libraries=services,clusterer&autoload=false"></script>
</head>
<body>
  <div id="map"></div>

  <!-- ë¹ ë¥¸ ì•¡ì…˜(FAB): ë‚´ ìœ„ì¹˜ë¡œ ì´ë™ + ë°”ë¡œ ê²€ìƒ‰ -->
  <button id="btnMyFab" class="fab">ë‚´ ìœ„ì¹˜</button>

  <!-- í•˜ë‹¨ ì‹œíŠ¸ -->
  <div id="sheet" class="sheet min grab" role="dialog" aria-label="ê²€ìƒ‰ íŒ¨ë„">
    <div class="handle" title="íŒ¨ë„ ë“œë˜ê·¸"></div>
    <div class="stack">
      <div class="row">
        <input id="place" placeholder="ì–´ë””ì—ì„œ? (ì˜ˆ: í™ëŒ€ì…êµ¬ì—­, ì„±ìˆ˜ë™, ì£¼ì†Œ)" inputmode="search" />
      </div>
      <div class="row">
        <input id="keyword" placeholder="ë¬´ì—‡ì„? (ì˜ˆ: ì¹´í˜, í¸ì˜ì , ì•½êµ­ Â· ë¹„ìš°ë©´ ê¸°ë³¸ê°’)" inputmode="search" />
      </div>
      <div class="row">
        <select id="radius" aria-label="ê²€ìƒ‰ ë°˜ê²½">
          <option value="500">500m</option>
          <option value="1000" selected>1km</option>
          <option value="2000">2km</option>
          <option value="3000">3km</option>
        </select>
        <button id="btnSearch">ê²€ìƒ‰</button>
      </div>
      <div class="status" id="status">ì´ˆê¸°í™” ì¤‘...</div>
    </div>
  </div>

  <script>
  // ======= ê³µìš© ìœ í‹¸ =======
  const $ = (s)=>document.querySelector(s);
  function postOutbound(payload){
    try{
      const data = JSON.stringify(payload);
      if (window.ReactNativeWebView) window.ReactNativeWebView.postMessage(data);
      else if (window.parent && window.parent !== window) window.parent.postMessage(data, '*');
    }catch(e){}
  }
  function emitStatus(text){
    const el = $('#status'); if (el) el.textContent = text;
    postOutbound({ type:'SEARCH_STATUS', text });
  }

  // ======= í•˜ë‹¨ ì‹œíŠ¸ í† ê¸€(ì ‘ê¸°/í´ê¸°) =======
  (function sheetInit(){
    const sheet = $('#sheet');
    let open = false; // false=min, true=max
    const set = (v)=>{ open=v; sheet.classList.toggle('max', open); sheet.classList.toggle('min', !open); };
    const toggle = ()=>set(!open);
    set(false); // ê¸°ë³¸ ì ‘í˜

    // ë“œë˜ê·¸/íƒ­ìœ¼ë¡œ í† ê¸€
    let startY=null, moved=false;
    sheet.addEventListener('pointerdown', (e)=>{ if (e.target.closest('.handle')){ startY=e.clientY; moved=false; sheet.setPointerCapture(e.pointerId); }});
    sheet.addEventListener('pointermove', (e)=>{ if(startY!==null && Math.abs(e.clientY-startY)>12) moved=true; });
    sheet.addEventListener('pointerup', (e)=>{ if(startY!==null){ if(!moved) toggle(); else toggle(); startY=null; moved=false; }});
    // ì…ë ¥ í¬ì»¤ìŠ¤ ì‹œ ìë™ í¼ì¹¨ (í‚¤ë³´ë“œ ì˜¬ë¼ì˜¬ ë•Œ ê°€ë ¤ì§€ì§€ ì•Šë„ë¡)
    ['#place','#keyword'].forEach(s=>{
      $(s).addEventListener('focus', ()=>set(true));
    });
  })();

  // ======= Kakao SDK ì¤€ë¹„/ì§€ë„ =======
  if (!window.kakao){ emitStatus('âŒ Kakao SDK ë¡œë“œ ì‹¤íŒ¨ â€” ë„ë©”ì¸/í‚¤ í™•ì¸'); throw new Error('Kakao SDK not loaded'); }

  kakao.maps.load(function(){
    const map = new kakao.maps.Map($('#map'), {
      center: new kakao.maps.LatLng(37.4979, 127.0276), // ê°•ë‚¨ì—­
      level: 5
    });
    const ps = new kakao.maps.services.Places();
    const clusterer = new kakao.maps.MarkerClusterer({ map, averageCenter:true, minLevel:6 });

    const $place = $('#place'), $keyword = $('#keyword'), $radius = $('#radius');
    let markers = [], originMarker=null;

    function clearMarkers(){ markers.forEach(m=>m.setMap(null)); markers=[]; clusterer.clear(); }
    function setOrigin(lat, lng){
      if (originMarker) originMarker.setMap(null);
      originMarker = new kakao.maps.Marker({
        position: new kakao.maps.LatLng(lat,lng),
        zIndex: 10
      });
      originMarker.setMap(map);
      map.setCenter(originMarker.getPosition());
    }
    function addPlaceMarker(place){
      const m = new kakao.maps.Marker({ position: new kakao.maps.LatLng(place.y, place.x) });
      const html =
        `<div style="padding:8px;min-width:180px;">
          <b>${place.place_name||''}</b><br>
          <small style="color:#666">${place.road_address_name||place.address_name||''}</small>
          ${place.phone ? `<br><small style="color:#06c">${place.phone}</small>` : ''}
        </div>`;
      const info = new kakao.maps.InfoWindow({ content: html });
      kakao.maps.event.addListener(m, 'click', function(){
        info.open(map, m);
        postOutbound({ type:'PLACE_SELECTED',
          place:{ id:place.id, name:place.place_name,
                  lat:parseFloat(place.y), lng:parseFloat(place.x),
                  address:place.address_name, roadAddress:place.road_address_name,
                  phone:place.phone, place_url:place.place_url }});
      });
      markers.push(m);
      return m;
    }

    function searchNearby(center, kw, radius){
      clearMarkers();
      const keyword = (kw && kw.trim()) ? kw.trim() : 'ë…¸ë˜ë°©';
      const rad = Math.min(Math.max(parseInt(radius||'1000',10), 100), 5000);
      emitStatus(`ğŸ” ê²€ìƒ‰ ì¤‘... ${keyword} Â· ${rad}m`);
      ps.keywordSearch(keyword, function(data, status){
        if (status === kakao.maps.services.Status.OK && data && data.length){
          const uniq={}; data.forEach(p=>{ const k=p.id||(p.x+','+p.y); if(!uniq[k]) uniq[k]=p; });
          const list=Object.values(uniq);
          const ms=list.map(addPlaceMarker);
          clusterer.addMarkers(ms);
          emitStatus(`âœ… ${list.length}ê°œ ì°¾ìŒ Â· ${rad}m`);
          const c=map.getCenter();
          postOutbound({ type:'SEARCH_DONE', keyword, count:list.length, radius: rad, center:{lat:c.getLat(), lng:c.getLng()}});
        }else{
          emitStatus(`âš ï¸ ê²°ê³¼ ì—†ìŒ (status=${status})`);
          const c=map.getCenter();
          postOutbound({ type:'SEARCH_DONE', keyword, count:0, radius: rad, center:{lat:c.getLat(), lng:c.getLng()}});
        }
      }, { location:center, radius:rad });
    }

    function resolvePlaceAndCenter(query, cb){
      if (!query || !query.trim()) return cb && cb(null);
      ps.keywordSearch(query.trim(), function(data, status){
        if (status === kakao.maps.services.Status.OK && data && data.length){
          const p=data[0]; const lat=parseFloat(p.y), lng=parseFloat(p.x);
          setOrigin(lat,lng); map.setLevel(5);
          cb && cb(new kakao.maps.LatLng(lat,lng));
        }else{ emitStatus('âš ï¸ ì¥ì†Œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤'); cb && cb(null); }
      }, { size: 10 });
    }

    // ë²„íŠ¼/ì•¡ì…˜
    $('#btnSearch').addEventListener('click', function(){
      const rad = $radius.value;
      const q = ($place.value || '').trim();
      const kw = ($keyword.value || '').trim();

    // ì¥ì†Œê°€ ë¹„ì–´ ìˆìœ¼ë©´: í˜„ì¬ ì§€ë„ ì¤‘ì‹¬ìœ¼ë¡œ ì§„í–‰
    if (!q) {
      emitStatus('ğŸ“ ì¥ì†Œ ë¯¸ì…ë ¥ â€” í˜„ì¬ ì§€ë„ ì¤‘ì‹¬ìœ¼ë¡œ ê²€ìƒ‰í•©ë‹ˆë‹¤');
      searchNearby(map.getCenter(), kw, rad);
      return;
    }

    // ì¥ì†Œê°€ ìˆìœ¼ë©´: ê¸°ì¡´ì²˜ëŸ¼ ì¢Œí‘œ í•´ì„ í›„ ì§„í–‰
    resolvePlaceAndCenter(q, c => {
      if (!c) return; // í•´ì„ ì‹¤íŒ¨ ì‹œ ì¢…ë£Œ
      searchNearby(c, kw, rad);
    });
  });


    // FAB: ë‚´ ìœ„ì¹˜ë¡œ ì´ë™ + ì¦‰ì‹œ ê²€ìƒ‰
    $('#btnMyFab').addEventListener('click', function(){
      if (!navigator.geolocation) return emitStatus('âš ï¸ ìœ„ì¹˜ ê¶Œí•œì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      navigator.geolocation.getCurrentPosition(function(pos){
        setOrigin(pos.coords.latitude, pos.coords.longitude);
        map.setLevel(5);
        const rad=$radius.value, kw=($keyword.value||'').trim();
        if (!kw) {
          emitStatus('ğŸ“ ë‚´ ìœ„ì¹˜ë¡œ ì´ë™ â€” í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ê³  [ê²€ìƒ‰]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”');
          return; // í‚¤ì›Œë“œ ë¹„ì–´ ìˆìœ¼ë©´ ê²€ìƒ‰ ì•ˆ í•¨
        }
        searchNearby(map.getCenter(), kw, rad);
      }, function(){ emitStatus('âš ï¸ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤'); });
    });

    // ì§€ë„ í´ë¦­: ì¤‘ì‹¬ë§Œ ì´ë™(ìë™ ê²€ìƒ‰ X)
    kakao.maps.event.addListener(map, 'click', function(e){
      setOrigin(e.latLng.getLat(), e.latLng.getLng());
      emitStatus('ğŸ“ ì„ íƒí•œ ì§€ì ìœ¼ë¡œ ì¤‘ì‹¬ ì´ë™');
    });

    // ë¶€ëª¨/Expo â†’ ì œì–´ ë©”ì‹œì§€(í˜¸í™˜ ìœ ì§€)
    function handleMsg(raw){
      try{
        const o=JSON.parse(raw);
        if (o.type==='CENTER' && typeof o.lat==='number' && typeof o.lng==='number'){
          setOrigin(o.lat,o.lng); if(o.level) map.setLevel(o.level);
        }else if(o.type==='FIND_PLACE' && o.query){
          resolvePlaceAndCenter(o.query, c=>{ if(c && o.autoSearch) searchNearby(c, $('#keyword').value, parseInt($radius.value||'1000',10)); });
        }else if(o.type==='SET_KEYWORD'){ $('#keyword').value=(o.keyword||''); }
        else if(o.type==='SET_RADIUS'){ $radius.value=String(o.radius||1000); }
        else if(o.type==='SEARCH_NOW'){
          if (!$('#place').value.trim()) {
            alert('ì¥ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); 
            emitStatus('âš ï¸ ì¥ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); 
          } else { 
            resolvePlaceAndCenter($('#place').value, c=>{ 
              if (c) searchNearby(c, $('#keyword').value, parseInt($radius.value||'1000',10)); 
            }); 
          } }
      }catch(e){}
    }
    window.addEventListener('message', e=>handleMsg(e.data));
    document.addEventListener('message', e=>handleMsg(e.data));

    // ì´ˆê¸° ìƒíƒœ
    emitStatus('âœ… ì§€ë„ ë¡œë“œ ì™„ë£Œ â€” ì•„ë˜ íŒ¨ë„ì—ì„œ ê²€ìƒ‰í•˜ì„¸ìš”');
    setOrigin(37.4979, 127.0276);
  });
  </script>
</body>
</html>
