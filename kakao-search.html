<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>지도 검색(키워드/반경/장소) - Kakao</title>
  <style>
    /* Reset & base */
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;}
    #map{position:fixed;inset:0;z-index:0;} /* 전체 화면 지도 */
    /* 하단 시트 */
    .sheet{
      position:fixed;left:0;right:0;bottom:0;z-index:10;
      background:#fff;border-top:1px solid #eee;
      border-top-left-radius:16px;border-top-right-radius:16px;
      box-shadow:0 -8px 24px rgba(0,0,0,.08);
      padding:8px 12px calc(8px + env(safe-area-inset-bottom)); /* iOS Safe Area */
      transition:transform .18s ease;
    }
    .sheet.grab{cursor:grab}
    .sheet .handle{width:40px;height:4px;background:#d8d8d8;border-radius:2px;margin:4px auto 10px;}
    .sheet .row{display:flex;gap:8px;align-items:center}
    .sheet .stack{display:flex;flex-direction:column;gap:8px}
    .sheet input,.sheet select{
      padding:14px;border:1px solid #ddd;border-radius:12px;font-size:16px;flex:1;min-width:0
    }
    .sheet button{
      padding:14px 16px;border:0;border-radius:12px;background:#111;color:#fff;font-weight:700;font-size:16px
    }
    .sheet .status{
      margin-top:8px;color:#666;font-size:13px;line-height:1.3;min-height:18px
    }
    .fab{
      position:fixed;right:16px;bottom:calc(84px + env(safe-area-inset-bottom));
      z-index:9;border:0;border-radius:999px;
      padding:14px 16px;font-weight:700;background:#111;color:#fff;
      box-shadow:0 6px 20px rgba(0,0,0,.15);
    }
    /* 접기/펴기 상태 */
    .sheet.min{ transform:translateY(calc(100% - 64px - env(safe-area-inset-bottom))); }
    .sheet.max{ transform:translateY(0); }
    /* 넓은 화면(태블릿/데스크탑)에서는 미니 높이 줄임 */
    @media (min-width:768px){
      .sheet.min{ transform:translateY(calc(100% - 76px)); }
      .fab{ bottom:110px; }
    }
  </style>

  <!-- Kakao SDK: 실제 JS 키 + 도메인(https://hanuseok.github.io) 등록 필수 -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=d1edc654e39b717ae9109665b63453f6&libraries=services,clusterer&autoload=false"></script>
</head>
<body>
  <div id="map"></div>

  <!-- 빠른 액션(FAB): 내 위치로 이동 + 바로 검색 -->
  <button id="btnMyFab" class="fab">내 위치</button>

  <!-- 하단 시트 -->
  <div id="sheet" class="sheet min grab" role="dialog" aria-label="검색 패널">
    <div class="handle" title="패널 드래그"></div>
    <div class="stack">
      <div class="row">
        <input id="place" placeholder="어디에서? (예: 홍대입구역, 성수동, 주소)" inputmode="search" />
      </div>
      <div class="row">
        <input id="keyword" placeholder="무엇을? (예: 카페, 편의점, 약국 · 비우면 기본값)" inputmode="search" />
      </div>
      <div class="row">
        <select id="radius" aria-label="검색 반경">
          <option value="500">500m</option>
          <option value="1000" selected>1km</option>
          <option value="2000">2km</option>
          <option value="3000">3km</option>
        </select>
        <button id="btnSearch">검색</button>
      </div>
      <div class="status" id="status">초기화 중...</div>
    </div>
  </div>

  <script>
  // ======= 공용 유틸 =======
  const $ = (s)=>document.querySelector(s);
  function postOutbound(payload){
    try{
      const data = JSON.stringify(payload);
      if (window.ReactNativeWebView) window.ReactNativeWebView.postMessage(data);
      else if (window.parent && window.parent !== window) window.parent.postMessage(data, '*');
    }catch(e){}
  }
  function emitStatus(text){
    const el = $('#status'); if (el) el.textContent = text;
    postOutbound({ type:'SEARCH_STATUS', text });
  }

  // ======= 하단 시트 토글(접기/펴기) =======
  (function sheetInit(){
    const sheet = $('#sheet');
    let open = false; // false=min, true=max
    const set = (v)=>{ open=v; sheet.classList.toggle('max', open); sheet.classList.toggle('min', !open); };
    const toggle = ()=>set(!open);
    set(false); // 기본 접힘

    // 드래그/탭으로 토글
    let startY=null, moved=false;
    sheet.addEventListener('pointerdown', (e)=>{ if (e.target.closest('.handle')){ startY=e.clientY; moved=false; sheet.setPointerCapture(e.pointerId); }});
    sheet.addEventListener('pointermove', (e)=>{ if(startY!==null && Math.abs(e.clientY-startY)>12) moved=true; });
    sheet.addEventListener('pointerup', (e)=>{ if(startY!==null){ if(!moved) toggle(); else toggle(); startY=null; moved=false; }});
    // 입력 포커스 시 자동 펼침 (키보드 올라올 때 가려지지 않도록)
    ['#place','#keyword'].forEach(s=>{
      $(s).addEventListener('focus', ()=>set(true));
    });
  })();

  // ======= Kakao SDK 준비/지도 =======
  if (!window.kakao){ emitStatus('❌ Kakao SDK 로드 실패 — 도메인/키 확인'); throw new Error('Kakao SDK not loaded'); }

  kakao.maps.load(function(){
    const map = new kakao.maps.Map($('#map'), {
      center: new kakao.maps.LatLng(37.4979, 127.0276), // 강남역
      level: 5
    });
    const ps = new kakao.maps.services.Places();
    const clusterer = new kakao.maps.MarkerClusterer({ map, averageCenter:true, minLevel:6 });

    const $place = $('#place'), $keyword = $('#keyword'), $radius = $('#radius');
    let markers = [], originMarker=null;

    function clearMarkers(){ markers.forEach(m=>m.setMap(null)); markers=[]; clusterer.clear(); }
    function setOrigin(lat, lng){
      if (originMarker) originMarker.setMap(null);
      originMarker = new kakao.maps.Marker({
        position: new kakao.maps.LatLng(lat,lng),
        zIndex: 10
      });
      originMarker.setMap(map);
      map.setCenter(originMarker.getPosition());
    }
    function addPlaceMarker(place){
      const m = new kakao.maps.Marker({ position: new kakao.maps.LatLng(place.y, place.x) });
      const html =
        `<div style="padding:8px;min-width:180px;">
          <b>${place.place_name||''}</b><br>
          <small style="color:#666">${place.road_address_name||place.address_name||''}</small>
          ${place.phone ? `<br><small style="color:#06c">${place.phone}</small>` : ''}
        </div>`;
      const info = new kakao.maps.InfoWindow({ content: html });
      kakao.maps.event.addListener(m, 'click', function(){
        info.open(map, m);
        postOutbound({ type:'PLACE_SELECTED',
          place:{ id:place.id, name:place.place_name,
                  lat:parseFloat(place.y), lng:parseFloat(place.x),
                  address:place.address_name, roadAddress:place.road_address_name,
                  phone:place.phone, place_url:place.place_url }});
      });
      markers.push(m);
      return m;
    }

    function searchNearby(center, kw, radius){
      clearMarkers();
      const keyword = (kw && kw.trim()) ? kw.trim() : '노래방';
      const rad = Math.min(Math.max(parseInt(radius||'1000',10), 100), 5000);
      emitStatus(`🔍 검색 중... ${keyword} · ${rad}m`);
      ps.keywordSearch(keyword, function(data, status){
        if (status === kakao.maps.services.Status.OK && data && data.length){
          const uniq={}; data.forEach(p=>{ const k=p.id||(p.x+','+p.y); if(!uniq[k]) uniq[k]=p; });
          const list=Object.values(uniq);
          const ms=list.map(addPlaceMarker);
          clusterer.addMarkers(ms);
          emitStatus(`✅ ${list.length}개 찾음 · ${rad}m`);
          const c=map.getCenter();
          postOutbound({ type:'SEARCH_DONE', keyword, count:list.length, radius: rad, center:{lat:c.getLat(), lng:c.getLng()}});
        }else{
          emitStatus(`⚠️ 결과 없음 (status=${status})`);
          const c=map.getCenter();
          postOutbound({ type:'SEARCH_DONE', keyword, count:0, radius: rad, center:{lat:c.getLat(), lng:c.getLng()}});
        }
      }, { location:center, radius:rad });
    }

    function resolvePlaceAndCenter(query, cb){
      if (!query || !query.trim()) return cb && cb(null);
      ps.keywordSearch(query.trim(), function(data, status){
        if (status === kakao.maps.services.Status.OK && data && data.length){
          const p=data[0]; const lat=parseFloat(p.y), lng=parseFloat(p.x);
          setOrigin(lat,lng); map.setLevel(5);
          cb && cb(new kakao.maps.LatLng(lat,lng));
        }else{ emitStatus('⚠️ 장소를 찾지 못했습니다'); cb && cb(null); }
      }, { size: 10 });
    }

    // 버튼/액션
    $('#btnSearch').addEventListener('click', function(){
      const rad = $radius.value;
      const q = ($place.value || '').trim();
      const kw = ($keyword.value || '').trim();

    // 장소가 비어 있으면: 현재 지도 중심으로 진행
    if (!q) {
      emitStatus('📍 장소 미입력 — 현재 지도 중심으로 검색합니다');
      searchNearby(map.getCenter(), kw, rad);
      return;
    }

    // 장소가 있으면: 기존처럼 좌표 해석 후 진행
    resolvePlaceAndCenter(q, c => {
      if (!c) return; // 해석 실패 시 종료
      searchNearby(c, kw, rad);
    });
  });


    // FAB: 내 위치로 이동 + 즉시 검색
    $('#btnMyFab').addEventListener('click', function(){
      if (!navigator.geolocation) return emitStatus('⚠️ 위치 권한을 사용할 수 없습니다');
      navigator.geolocation.getCurrentPosition(function(pos){
        setOrigin(pos.coords.latitude, pos.coords.longitude);
        map.setLevel(5);
        const rad=$radius.value, kw=($keyword.value||'').trim();
        if (!kw) {
          emitStatus('📍 내 위치로 이동 — 키워드를 입력하고 [검색]을 눌러주세요');
          return; // 키워드 비어 있으면 검색 안 함
        }
        searchNearby(map.getCenter(), kw, rad);
      }, function(){ emitStatus('⚠️ 위치를 가져오지 못했습니다'); });
    });

    // 지도 클릭: 중심만 이동(자동 검색 X)
    kakao.maps.event.addListener(map, 'click', function(e){
      setOrigin(e.latLng.getLat(), e.latLng.getLng());
      emitStatus('📍 선택한 지점으로 중심 이동');
    });

    // 부모/Expo → 제어 메시지(호환 유지)
    function handleMsg(raw){
      try{
        const o=JSON.parse(raw);
        if (o.type==='CENTER' && typeof o.lat==='number' && typeof o.lng==='number'){
          setOrigin(o.lat,o.lng); if(o.level) map.setLevel(o.level);
        }else if(o.type==='FIND_PLACE' && o.query){
          resolvePlaceAndCenter(o.query, c=>{ if(c && o.autoSearch) searchNearby(c, $('#keyword').value, parseInt($radius.value||'1000',10)); });
        }else if(o.type==='SET_KEYWORD'){ $('#keyword').value=(o.keyword||''); }
        else if(o.type==='SET_RADIUS'){ $radius.value=String(o.radius||1000); }
        else if(o.type==='SEARCH_NOW'){
          if (!$('#place').value.trim()) {
            alert('장소를 입력해주세요'); 
            emitStatus('⚠️ 장소를 입력해주세요'); 
          } else { 
            resolvePlaceAndCenter($('#place').value, c=>{ 
              if (c) searchNearby(c, $('#keyword').value, parseInt($radius.value||'1000',10)); 
            }); 
          } }
      }catch(e){}
    }
    window.addEventListener('message', e=>handleMsg(e.data));
    document.addEventListener('message', e=>handleMsg(e.data));

    // 초기 상태
    emitStatus('✅ 지도 로드 완료 — 아래 패널에서 검색하세요');
    setOrigin(37.4979, 127.0276);
  });
  </script>
</body>
</html>
